<html>
<!--

imbraw2dng.html

Convert RAW from I'm back(R)(https://imback.eu) into DNG

Stefan Hegny, 2023

https://github.com/shyrodgau/imbraw2dng

Free software, use at own risk for whatever you like

Use: open in browser and select RAW

Todo:
optimize color matrix
-->
<head>
<title>ImB RAW to DNG Converter V1.1.2_DEVEL</title>
<script type="text/javascript" language="javascript">
let totnum=0, actnum=0;
function writeinttoout(out, num, off) {
	out[off] = (num % 256);
	out[off + 1] = (num / 256) % 256;
	out[off + 2] = (num / 65536) % 256;
	out[off + 3] = (num / 16777216) % 256;
}
function fselected() {
	totnum = 0; actnum = 0;
	const el = document.getElementById('infile');
	const f = el.files[0];
	handleone(f);
}
function handleone(f) {
	const msg = document.getElementById('outmsg');
	const xmsg = document.getElementById('xmsg');
	xmsg.style["display"] = "";
	if (undefined === f) {
		msg.innerHTML += "Nothing selected...?<br>&nbsp;<br>";
		return;
	}
	let rawname = f.name;
	while (rawname.indexOf("/") > -1) {
		rawname = rawname.substring(rawname.indexOf("/") + 1);
	}
	if (rawname.substring(rawname.length -4).toUpperCase() !== '.RAW') {
		const reader = new FileReader();
		reader.onload = function(evt) {
			if (totnum !== 0) {
				msg.innerHTML += ("[" + ++actnum + " / " + totnum + "] ");
			}
			msg.innerHTML += "Passing through as not raw: " + f.name + "<br>";
			const contents = evt.target.result;
			const view = new DataView(contents);
			const out = new Uint8Array(f.size);
			for (let j=0; j<contents.byteLength; j++) {
				out[j] = view.getUint8(j);
			}
			const b = new Blob([ out ], { type: "application/octet-stream"});
			const outel = document.getElementById('result');
			outel.download = rawname;
			const thisurl = URL.createObjectURL(b);
			outel.href = thisurl;
			outel.click();
			msg.innerHTML += "<b style=\"background-color:#ddffdd;\">Finished! Copied to " + rawname + " (Check Download Folder)</b> <a download=\"" + rawname + "\" href=\"" + thisurl + "\">Manually download again</a><br>&nbsp;<br>";
		}
		reader.onerror = function(evt) {
			msg.innerHTML += "<b style=\"background-color:#ffdddd;\">Error occured reading file " + f.name + ". SORRY! </b><br>&nbsp;<br>";
		}
		reader.readAsArrayBuffer(f);
		return;
	}
	// we know it ends with ".raw"
	rawname = rawname.substring(0, rawname.length - 3);
	const rawarr = new TextEncoder().encode(rawname);
	let datestr="", dateaddoff = 0, dateok = false;
	// date?
	const yr = Number.parseInt(rawname.substring(0,4));
	if (yr >= 2019 && yr < 3000 && JSON.stringify(yr) === rawname.substring(0,4)) {
		let mon = Number.parseInt(rawname.substring(5,7));
		if (mon > 0 && mon < 13 && (JSON.stringify(mon) === rawname.substring(5,7) ||
			"0" + mon === rawname.substring(5,7))) {
			let day = Number.parseInt(rawname.substring(7,9));
			if (day > 0 && day < 32 && (JSON.stringify(day) === rawname.substring(7,9) ||
				"0" + day === rawname.substring(7,9))) {
				let hr = Number.parseInt(rawname.substring(10,12));
				if (hr >= 0 && hr < 25 && (JSON.stringify(hr) === rawname.substring(10,12) ||
					"0" + hr === rawname.substring(10,12))) {
					let min = Number.parseInt(rawname.substring(12,14));
					if (min >= 0 && min <= 60 && (JSON.stringify(min) === rawname.substring(12,14) ||
						"0" + min === rawname.substring(12,14))) {
						let sec = Number.parseInt(rawname.substring(14,16));
						if (sec >= 0 && sec <= 60 && (JSON.stringify(sec) === rawname.substring(14,16) || // maybe leap second?
							"0" + sec === rawname.substring(14,16))) {
							datestr = "" + yr + ":" + ((mon < 10) ? "0":"") + mon + ":" + ((day < 10) ? "0":"") + day + " "+
								((hr < 10) ? "0":"") + hr + ":" + ((min < 10) ? "0":"") + min + ":" + ((sec < 10) ? "0":"") + sec;
							if (datestr.length === 19) {
								dateaddoff = 24;
								dateok = true;
							}
						}
					}
				}
			}
		}
	}
	let w, h, mode = "??";
	let typ = 0;
	const types = [ "unknown", "ImB35mm", "MF 6x7 ", "MF6x4.5", "MF 6x6 " ];
	if (f.size === 14065920) {
		w = 4320; h = 3256;
		mode = "historic (4320x3256)";
	}
	else if (f.size === 15925248) {
		w = 4608; h = 3456;
		typ = 2;
		mode = "(4608x3456)";
	}
	else if (f.size === 12076120) {
		w = 4012; h = 3010;
		typ = 2;
		mode = "Medium-angle (4012x3010)";
	}
	else if (f.size === 7967440) {
		w = 3260; h = 2444;
		typ = 2;
		mode = "Small-angle (3260x2444)";
	}
	else if (f.size === 12937632) {
		w = 4152; h = 3116;
		typ = 3;
		mode = "(4152x3116)";
	}
	else if (f.size === 9806592) {
		w = 3616; h = 2712;
		typ = 3;
		mode = "Medium-angle (2616x2717)";
	}
	else if (f.size === 6470944) {
		w = 2936; h = 2204;
		typ = 3;
		mode = "Small-angle (2936x2204)";
	}
	else if (f.size === 11943936) {
		w = 3456; h = 3456;
		typ = 4;
		mode = "(3456x3456)";
	}
	else if (f.size === 9060100) {
		w = 3010; h = 3010;
		typ = 4;
		mode = "Medium-angle (3010x3010)";
	}
	else if (f.size === 5973136) {
		w = 2444; h = 2444;
		typ = 4;
		mode = "Small-angle (2444x2444)";
	}
	else if (f.size === 15335424) {
		w = 4608; h = 3328;
		typ = 1;
		mode = "(4608x3328)";
	}
	else if (f.size === 11618752) {
		w = 4012; h = 2896;
		typ = 1;
		mode = "Medium-angle (4012x2896)";
	}
	else if (f.size === 7667520) {
		w = 3260; h = 2352;
		typ = 1;
		mode = "Small-angle (3260x2352)";
	}
	else {
		if (totnum !== 0) {
			msg.innerHTML += ("[" + ++actnum + " / " + totnum + "] ");
		}
	    	msg.innerHTML += "<b style=\"background-color:#ffdddd;\">[" + f.name + "] Sorry, file Size <b>" + f.size + "</b> does not match known formats. Contact developer.</b><br>&nbsp;<br>";
		return;
	}
	const reader = new FileReader();
	reader.onload = function(evt) {
		if (totnum !== 0) {
			msg.innerHTML += ("[" + ++actnum + " / " + totnum + "] ");
		}
		msg.innerHTML += "Processing file: " + f.name + "<br>";
		msg.innerHTML += "Assuming " + types[typ] + " " + mode + "<br>";
		if (dateok) {
			msg.innerHTML += "Date/Time: " + datestr + "<br>";
		}
		const contents = evt.target.result;
		const view = new DataView(contents);
		const out = new Uint8Array(f.size + (dateok ? 466: 422));
		out[0] = 0x49;
		out[1] = 0x49;
		out[2] = 0x2a;
		out[3] = 0;
		writeinttoout(out, 8 + f.size, 4);
		let k = 8;
		for (let j=0; j<contents.byteLength; j++) {
			out[k++] = view.getUint8(j);
		}
		if (dateok)
			out[k++] = 0x19;
		else
			out[k++] = 0x17;
		const rest0 = [
			0x00, 0xfe, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00
		]; /* followed by 4b width */
		out.set(rest0, k);
		k += rest0.length;
		writeinttoout(out, w, k);
		k += 4;

		const rest1 = [
			0x01, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00
		]; /* followed by 4b height */
		out.set(rest1, k);
		k += rest1.length;
		writeinttoout(out, h, k);
		k += 4;

		const rest2 = [ 0x02, 0x01,
			0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x23, 0x80,
			0x00, 0x00, 0x0f, 0x01, 0x02, 0x00, 0x07, 0x00, 0x00, 0x00 ];
		out.set(rest2, k);
		k += rest2.length;
		writeinttoout(out, f.size + (dateaddoff + 290), k);
		k += 4;

		const rest3 = [ 0x10, 0x01, 0x02, 0x00, 0x08, 0x00, 0x00, 0x00 ];
		out.set(rest3, k);
		k += rest3.length;
		writeinttoout(out, f.size + (dateaddoff + 298), k);
		k += 4;

		const rest4 = [ 0x11, 0x01, 0x04, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x12, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x17, 0x01,
			0x04, 0x00, 0x01, 0x00, 0x00, 0x00 ];
		out.set(rest4, k);
		k += rest4.length;
		writeinttoout(out, f.size, k);
		k += 4;

		const rest5 = [ 0x1c, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x31, 0x01, 0x02, 0x00, 0x0b, 0x00, 0x00, 0x00 ];
		out.set(rest5, k);
		k += rest5.length;
		writeinttoout(out, f.size + (dateaddoff + 306), k);
		k += 4;

		if (dateok) {
			const rest5a = [ 0x32, 0x01, 0x02, 0x00, 0x14, 0x00, 0x00, 0x00 ];
			out.set(rest5a, k);
			k += rest5a.length;
			writeinttoout(out, f.size + 446, k);
			k += 4;
		}

		const rest6 = [ 0x8d, 0x82, 0x03, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x8e, 0x82, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00 ];
		out.set(rest6, k);
		k += rest6.length;
		const cfa35 = [ 0x01, 0x00, 0x02, 0x01 ];
		const cfamf = [ 0x02, 0x01, 0x01, 0x00 ]
		if (typ > 1)
			out.set(cfamf, k);
		else
			out.set(cfa35, k);
		k += cfa35.length; // both have same length

		if (dateok) {
			const rest6a = [ 0x03, 0x90, 0x02, 0x00, 0x14, 0x00, 0x00, 0x00 ];
			out.set(rest6a, k);
			k += rest6a.length;
			writeinttoout(out, f.size + 446, k);
			k += 4;
		}
		const rest6c = [ 0x12, 0xc6, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x13, 0xc6, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x14, 0xc6, 0x02, 0x00, 0x07, 0x00, 0x00, 0x00 ];
		out.set(rest6c, k);
		k += rest6c.length;
		writeinttoout(out, (dateaddoff + 318) + f.size, k);
		k += 4;
		const rest7 = [ 0x1d, 0xc6, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x21, 0xc6, 0x0a, 0x00, 0x09, 0x00, 0x00, 0x00
		];
		out.set(rest7, k);
		k += rest7.length;
		writeinttoout(out, (dateaddoff + 326) + f.size, k);
		k += 4;

		const rest8 = [ 0x28, 0xc6, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00 ];
		out.set(rest8, k);
		k += rest8.length;
		writeinttoout(out, (dateaddoff + 398) + f.size, k);
		k += 4;

		const rest8b = [ 0x8b, 0xc6, 0x01, 0x00 ];
		out.set(rest8b, k);
		k += rest8b.length;
		writeinttoout(out, rawarr.length, k);
		k += 4;
		writeinttoout(out, (dateok ? 466: 422) + f.size, k);
		k += 4;
		
		const rest9 = [ 0x00, 0x00, 0x00, 0x00, 0x49, 0x6d, 0x42, 0x61, 0x63, 0x6b, 0x00, 0x00 ];
		out.set(rest9, k);
		k += rest9.length;
		out.set(new TextEncoder().encode(types[typ]), k);
		k += 7;
		const rest10 = [ 0x00, 0x69, 0x6d, 0x62, 0x72, 0x61, 0x77, 0x32, 0x64, 0x6e, 0x67,
			0x00, 0x00, 0x49, 0x6d, 0x42, 0x61, 0x63, 0x6b, 0x00, 0x00, 0xff, 0xff, 0xff, 0x7f, 0xf4, 0xb6,
			0x6d, 0x5b, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x7f, 0xf4, 0xb6,
			0x6d, 0x5b, 0xff, 0x99, 0x99, 0x99, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
			0x00, 0x00, 0xff, 0x99, 0x99, 0x99, 0xff, 0xff, 0xff, 0xff ];
		out.set(rest10, k);
		k += rest10.length;
		if (dateok) {
			const datearr = new TextEncoder().encode(datestr);
			out.set(datearr, f.size + 446);
			out[f.size + 465] = 0;
		}
		const b = new Blob([ out, rawarr ], { type: "image/x-adobe-dng"});
		const outel = document.getElementById('result');
		outel.download = rawname + 'dng';
		const thisurl = URL.createObjectURL(b);
		outel.href = thisurl;
		outel.click();
		msg.innerHTML += "<b style=\"background-color:#ddffdd;\">Finished! Converted to " + rawname + "dng (Check Download Folder)</b> <a type=\"image/x-adobe-dng\" download=\"" + rawname + "dng\" href=\"" + thisurl + "\">Manually download again</a>&nbsp;<br>&nbsp;<br>";
	}
	reader.onerror = function(evt) {
		msg.innerHTML += "<b style=\"background-color:#ffdddd;\">Error occured reading file " + f.name + ". SORRY! </b><br>&nbsp;<br>";
	}
	reader.readAsArrayBuffer(f);
}
function drophandler(ev) {
  const msg = document.getElementById('outmsg');
  const xmsg = document.getElementById('xmsg');
  xmsg.style["display"] = "";
  ev.preventDefault();
  if (ev.dataTransfer.items) {
    msg.innerHTML += "Got " + [...ev.dataTransfer.items].length + " files dropped.<br>&nbsp;<br>";
    totnum = [...ev.dataTransfer.items].length;
    actnum = 0;
    [...ev.dataTransfer.items].forEach((item, i) => {
      if (item.kind === "file") {
        const file = item.getAsFile();
        handleone(file);
      }
    });
  } else {
    msg.innerHTML += "Got " + [...ev.dataTransfer.files].length + " files dropped.<br>&nbsp;<br>";
    totnum = [...ev.dataTransfer.files].length;
    actnum = 0;
    [...ev.dataTransfer.files].forEach((file, i) => {
      handleone(file);
    });
  }
}
function prevdef(ev) {
	ev.preventDefault();
}
</script>
</head>
<body>
<div>ImB RAW to DNG Converter V1.1.2_DEVEL</div>
Drop Files from ImB here: <br>
(Browser may ask you if you want to allow downloading multiple files. Not RAW Files simply will be copied.)<br>
<div id="droptarget" ondrop="drophandler(event);" ondragenter="prevdef(event);" ondragover="prevdef(event);" style="border: 5px solid blue;width:300px; height:70px;background-color: rgba(0,0,255,0.2);"></div><br>
<div  style="font-size:133%;">Or select <b>RAW</b> File: <input type="file" accept=".raw,.RAW" id="infile" name="infile" onchange="fselected()"></div><br>
<!--Width if not standard file: <input type="number" min="2000" max="5000" id="inwidth" name="inwidth" onchange="showme()"><br>-->
&nbsp;<br>
<div id="xmsg" style="display: none; width: fit-content;white-space: pre;">Message Log:<br>
<div id="outmsg"></div></div>
<a style="display: none;" id="result">x</a>
</body>
</html>
