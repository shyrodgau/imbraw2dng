<html>
<!--
***************************************************** 

imbdng2raw.html

Convert converted DNG from I'm back(R)(https://imback.eu) back into RAW

https://github.com/shyrodgau/imbraw2dng

Usage: open in browser and select DNG

***************************************************** 

Copyright (C) 2023,2024 by Stefan Hegny, stefan@hegny.de

Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. 
IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, 
DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

// SPDX-License-Identifier: 0BSD

***************************************************** 
-->
<head>
<meta name="viewport" content="width=200, initial-scale=1" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ImB DNG to RAW Converter V???</title>
<script type="text/javascript" language="javascript">
"use strict;"
/* Main class */
class ImBC {
/* Indentation out */
#infos = [ // actually const
	{
		size: 14065920,
		w: 4320,
		h: 3256,
		typ: 0,
		mode: "historic"
	},
	{ /* MF 6x7 */
		size: 15925248,
		w: 4608,
		h: 3456,
		typ: 2,
		mode: ""
	},
	{ /* MF 6x4.5 */
		size: 12937632,
		w: 4152, h: 3116,
		typ: 3,
		mode: ""
	},
	{
		size: 9806592,
		w: 3616, h: 2712,
		typ: 3,
		mode: "Medium-angle"
	},
	{
		size: 6470944,
		w: 2936, h: 2204,
		typ: 3,
		mode: "Small-angle"
	},
	{ /* MF 6x6 */
		size: 11943936,
		w: 3456, h: 3456,
		typ: 4,
		mode: ""
	},
	{ /* 35mm */
		size: 15335424,
		w: 4608, h: 3328,
		typ: 1,
		mode: ""
	},
	{
		size: 11618752,
		w: 4012, h: 2896,
		typ: 1,
		mode: "Medium-angle"
	},
	{
		size: 7667520,
		w: 3260, h: 2352,
		typ: 1,
		mode: "Small-angle"
	}
	/* Film ? */
];

/* For processing several files */
#totnum=0;
#actnum=0;
#stats = { total: 0, skipped: 0, ok: 0, error: 0 };
#allfiles = [];
/* primitive basename helper */
#basename(n) {
	while (n.lastIndexOf("/") > -1) {
		n = n.substring(n.lastIndexOf("/") + 1);
	}
	return n;
}
/* helper to append message */
#appendmsg(msg)  {
	const msgel = document.getElementById('outmsg');
	const xmsg = document.getElementById('xmsg');
	xmsg.style["display"] = "";
	msgel.innerHTML += msg;
}
/* helper to read dng */
#readshort(view, off) {
	let res = view.getUint8(off);
	res += (256 * view.getUint8(off+1));
	return res;
}
/* helper to read dng */
#readint(view, off) {
	let res = this.#readshort(view, off);
	res += (65536 * this.#readshort(view,off+2));
	return res;
}
/* stupid helper */
#appendnl() {
	if (document) this.#appendmsg('<br>&nbsp;<br>');
}
/* browserdisplay: handler for file selection input */
fselected() {
	if (this.#actnum !== this.#allfiles.length) return;
    const stepprev = document.getElementById('steppreview');
	const el = document.getElementById('infile');
	this.#totnum = el.files.length;
	this.#actnum = 0;
	this.#stats = { total: this.#totnum, skipped: 0, error: 0, ok: 0 };
	this.#allfiles = el.files;
	if (this.#totnum > 0) {
		this.#appendmsg('Number of selected: ' + this.#totnum);
		this.#appendnl();
		document.getElementById('droptarget').style['display'] = 'none';
		document.getElementById('infile').disabled = true;
		this.#handleone();
	}
}
/* continue with the next file if any */
#handlenext() {
	if (this.#actnum < this.#allfiles.length - 1) {
		this.#actnum++;
		this.#handleone();
	} else {
		this.#actnum = 0;
		this.#allfiles = [];
		if (this.#stats.total > 0) {
			if (document) this.#appendnl();
			else this.#appendmsg('');
			this.#appendmsg('Statistic: Total: ' + this.#stats.total + ' - OK: ' + this.#stats.ok + ' - Error: ' + this.#stats.error);
			this.#appendnl();
		}
		document.getElementById('droptarget').style['display'] = '';
		document.getElementById('infile').disabled = false;
	}
}
/* handle dng like raw */
#parseDng(f, onok, onerr) {
	// blindly assumes that it is one of our own DNG
	// interesting tags: orientation, datetime
	if (undefined === f.data) {
		const reader = f.imbackextension ? f : new FileReader();
		reader.onload = (evt) => {
			f.data = evt.target.result;
			this.#parseDng(f, onok, onerr);
		}
		reader.onerror = (evt) => { onerr(f.name); };
		reader.readAsArrayBuffer(f);
		return;
	}
	const v = new DataView(f.data);
	const ifd = this.#readint(v, 4);
	const zz = this.#infos.findIndex((v, i, o) => v.size === ifd - 8);
	const nent = this.#readshort(v, ifd);
	let subifdstart = -1, rawstripstart = -1, datalen = -1;
	let off = ifd+2;
	if (this.#readshort(v, 2) !== 42 || this.#readshort(v,0) !== 18761 /* 0x4949 */ || zz === -1) {
		// seek sub ifd then therein the stripoffsets
		for (let k=0; k<((nent<50)? nent: 0); k++) {
			let tag = this.#readshort(v, off);
			if (tag === 330) {
				subifdstart = this.#readint(v, off+8);
				break;
			}
			off += 12;
		}
		if (-1 !== subifdstart) {
			let subnent = this.#readshort(v, subifdstart);
			off = subifdstart + 2;
			for (let j=0; j<((subnent < 50)? subnent: 0); j++) {
				let stag = this.#readshort(v, off);
				if (stag === 273) {
					rawstripstart = this.#readint(v, off+8);
					break;
				}
				off += 12;
			}
			if (-1 !== rawstripstart) {
				datalen = subifdstart - rawstripstart;
				const zzz = this.#infos.findIndex((v, i, o) => v.size === datalen);
				if (-1 === zzz) {
					this.#appendmsg('Works only for originally created DNGs.');
					return onerr(f.name);
				}
			}
			else {
				this.#appendmsg('Works only for originally created DNGs.');
				return onerr(f.name);
			}
		}
		else {
			this.#appendmsg('Works only for originally created DNGs.');
			return onerr(f.name);
		}
	}
	else {
		rawstripstart = 8;
		datalen = ifd - 8;
	}
	let fx = {
		imbackextension: true,
		name: f.name.substring(0, f.name.length - 4) + '.raw',
		size: datalen,
		data: f.data.slice(rawstripstart, datalen + rawstripstart)
	};
	off = ifd+2;
	for (let k=0; k<((nent<50)? nent: 0); k++) {
		let tag = this.#readshort(v, off);
		if (tag === 274)
			fx.rot = this.#readshort(v, off+8); // rotation handling has problems
		else if (tag === 306) {
			fx.datestr = '';
			let xoff = this.#readint(v, off+8);
			const len = this.#readshort(v, off+4)-1;
			for (let j=0; j<len;j++)
				fx.datestr += String.fromCharCode(v.getUint8(xoff++));
		}
		off += 12;
	}
	fx.readAsArrayBuffer = (fy) => {
		fy.onload({
				target: { result: fy.data }
		});
	};
	setTimeout(() => {
			onok(f.name, fx, fx.rot);
	});
}
/* actual processing function for one file */
#handleone(fx) {
	const f = (fx !== undefined) ? fx : this.#allfiles[this.#actnum];
	if (undefined === f) {
		//this.#mappx('process.nothing');
		this.#appendnl();
		return this.#handlenext();
	}
	let rawname = this.#basename(f.name);
	if (rawname.substring(rawname.length -4).toUpperCase() === '.DNG') {
		this.#parseDng(f, 
			(name, fx) => {
				this.#handleone(fx);
			},
			() => this.#handlenext());
		return;
	}
	else if (rawname.substring(rawname.length -4).toUpperCase() !== '.RAW') {
		this.#appendmsg("[" + (1 + this.#actnum) + " / " + this.#totnum + "] ");
		this.#appendmsg('Seems not to be DNG: ' + f.name);
		this.#appendnl();
		this.#stats.error++;
		return this.#handlenext();
	}
	let w, h, mode = "??";
	let typ = 0;
	const zz = this.#infos.findIndex((v, i, o) => v.size === f.size);
	if (zz !== -1) {
		this.#appendmsg("[" + (1 + this.#actnum) + " / " + this.#totnum + "] ");
		if (document) this.#appendmsg('<br>');
		const reader = f.imbackextension ? f : new FileReader();
		reader.onload = (evt) => {
			const contents = evt.target.result;
			const view = new DataView(contents);
			const out = new Uint8Array(f.size);
			for (let j=0; j<view.byteLength; j++) {
				out[j] = view.getUint8(j);
			}
			this.#output1(rawname, 'application/octet-stream', 'process.copyok', out);
		}
		reader.onerror = (evt) => {
			console.log('Unk-RAW process reader error for ' + f.name + ' ' + JSON.stringify(evt));
			this.#appendmsg('Error processing or reading file ' +  f.name);
			this.#appendnl();
			this.#stats.error++;
			this.#handlenext();
		}
		reader.readAsArrayBuffer(f);
	} else {
		this.#appendmsg("[" + (1 + this.#actnum) + " / " + this.#totnum + "] ");
		this.#appendmsg('Size of raw data of ' + f.name + ' seems not to match known formats, ignoring...');
		this.#appendnl();
		this.#stats.error++;
		this.#handlenext();
	}
}
/* output one thing via browser or nodejs */
#output1(name, type, okmsg, arr1) {
	let b = new Blob([ arr1 ], { type: type });
	const outel = document.getElementById('result');
	outel.download = name;
	const thisurl = URL.createObjectURL(b);
	outel.href = thisurl;
	outel.click();
	this.#appendmsg('Saved ok: ' + name + ' (Check downloads folder)');
	this.#appendnl();
	this.#stats.ok++;
	this.#appendmsg('');
	this.#handlenext();
}
/* browserdisplay: handler function for dropping OS files into the rect */
drophandler(ev) {
	if (this.#actnum !== this.#allfiles.length) return;
    const stepprev = document.getElementById('steppreview');
    //this.#stepmode = 0;
	//if (stepprev !== null && stepprev.checked) this.#stepmode = 1;
	ev.preventDefault();
	this.#allfiles = [];
	this.#actnum = 0;
	if (ev.dataTransfer.items) {
		this.#totnum = [...ev.dataTransfer.items].length;
		[...ev.dataTransfer.items].forEach((item, i) => {
			if (item.kind === "file") {
				const file = item.getAsFile();
				this.#allfiles.push(item.getAsFile());
			}
		});
	} else {
		this.#totnum = [...ev.dataTransfer.files].length;
		[...ev.dataTransfer.files].forEach((file, i) => {
			this.#allfiles.push(file);
		});
	}
	this.#stats = { total: this.#totnum, skipped: 0, error: 0, ok: 0 };
	this.#appendmsg('Number of dropped files: ' + this.#totnum);
	this.#appendnl();
	document.getElementById('droptarget').style['display'] = 'none';
	document.getElementById('infile').disabled = true;
	this.#handleone();
}
/* browserdisplay: some handler on the drop rectangle */
prevdef(ev) {
	ev.preventDefault();
}
/* indentation in - end of class ImBC */
};
let imbc;
/* onload of html body */
function init() {
	imbc = new ImBC();
}
</script>
</head>
<!-- here comes the html itself -->
<body style="font-family: Helvetica, Arial, sans-serif;" onload="init();" lang="en">
<div style="font-weight:bold;">DNG - to - RAW Converter</div>
<br><div>&nbsp;<br>This does the inverse operation of <a href="imbraw2dng.html">imbraw2dng.html</a> but only if the DNG is the original one.</div>
<!-- the normal display -->
<div id="normal" style="margin-top: 0.5em;">
<div id="notimback">
<div style="font-size:133%;margin-top: 0.5em;" data-myxlkey="main.drophere"></div>
<div id="droptarget" ondrop="imbc.drophandler(event);" ondragenter="imbc.prevdef(event);" ondragover="imbc.prevdef(event);" style="border: 5px solid blue;border-radius: 10px;width:300px; height:70px;background-color: rgba(0,0,255,0.2);"></div><br>
<div  style="font-size:133%;margin-top: 0.5em;"><span data-myxlkey="main.selectraw"></span> <input type="file" accept=".dng,.DNG" id="infile" name="infile" multiple onchange="imbc.fselected()"></div><br>
</div>
&nbsp;<br>
<div id="xmsg" style="display: none; width: fit-content;white-space: pre;"><span style="font-weight:bold;">Log: </span><br>
<div id="outmsg"></div></div>
</div>
<!-- end of the normal display -->
<!-- this is invisible -->
<a style="display: none;" id="result">x</a>
</body>
</html>
