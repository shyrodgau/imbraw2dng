/*

imbraw2dng.c

Convert RAW files from I'm back to DNG files for processing

Stefan Hegny, 2023

Free Software, use at own risk as you like

Compile: gcc -Wall -o imbraw2dng imbraw2dng.c

Run: ./imbraw2dng infile.raw [optional: width] > outfile.dng

*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

int main (int argc, char** argv) {
	unsigned int w = 4608, h = 3328;
	
	/* check parameters */
	if (argc < 2) {
		fprintf(stderr, "Usage: imbraw2dng infile.raw [width if != 4608] > outfile.dng\n");
		exit(0);
	}
	if (argc > 2) {
		w = atoi(argv[2]);
		fprintf(stderr, "Assuming image width %u\n", w);
	}
	
	
	/* check input file and its size */
	struct stat sb;
	if (stat(argv[1], &sb)) {
		fprintf(stderr, "Error on input file %s\n", argv[1]);
		perror("Error was: ");
		exit(1);
	}
	
	h = sb.st_size / w;
	if (h * w != sb.st_size) {
		fprintf(stderr, "Input File size does not fit! Expected %u B for WxH %u x %u but found %ld B\n", h * w, w, h, sb.st_size);
		exit(2);
	}
	
	/* build the DNG/TIFF stuff */
	const char hdr[] = { 'I', 'I', 0x2a, 0 };
	unsigned int off = 8 + (w * h);
	
	write(1, hdr, 4);
	write(1, &off, 4);
	
	/* input data follows */
	FILE *infile = fopen(argv[1], "rb");
	if (!infile) {
		fprintf(stderr, "Error reading input file %s\n", argv[1]);
		perror("Error was: ");
		exit(1);
	}
		
#define BUFSIZE 1000
	char buf[BUFSIZE];
	unsigned int fill, sum = 0;
	while ((fill = fread(buf, 1, BUFSIZE, infile))) {
		write(1, buf, fill);
		sum += fill;
	}
	fclose(infile);
	
	if (sum != w*h) {
		fprintf(stderr,"Could not read enough data from input file, only %u instead of %u B\n", sum, w*h);
	}
	const char rest0[] = {
		0x16, 0x00, 0xfe, 0x00, 0x04, 0x00, 0x01, 0x00 
		, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00
	}; /* followed by 4b width */
	
	write(1, rest0, sizeof(rest0));
	write(1, &w, 4);
	const char rest1[] = {
		0x01, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00
	}; /* followed by 4b height */
	write(1, rest1, sizeof(rest1));
	write(1, &h, 4);

	const char rest2[] = { 0x02, 0x01,
		0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x23, 0x80,
		0x00, 0x00, 0x0f, 0x01, 0x02, 0x00, 0x07, 0x00, 0x00, 0x00
	};
	write(1, rest2, sizeof(rest2));
	off = 278 + (w*h);
	write(1, &off, 4);
	
	/* w*h + 22 * /16  a2  d6  00*/
	const char rest3[] = { 0x10, 0x01,
		0x02, 0x00, 0x08, 0x00, 0x00, 0x00
	};
	write(1, rest3, sizeof(rest3));
	off = 286 + (w*h);
	write(1, &off, 4);
	
	/* w*h + 30 * /1e  a2  d6  00*/
	const char rest4[] = { 0x11, 0x01, 0x04, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x12, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x17, 0x01,
		0x04, 0x00, 0x01, 0x00, 0x00, 0x00
	}; /* w*h * /00  a1  d6  00*/
	write(1, rest4, sizeof(rest4));
	off = 0 + (w*h);
	write(1, &off, 4);
	
	const char rest5[] = { 0x1c, 0x01, 0x03, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x31, 0x01, 0x02, 0x00, 0x0b, 0x00, 0x00, 0x00
	}; /* w*h + 38 * /26  a2 0xd6  00 */ 
	write(1, rest5, sizeof(rest5));
	off = 294 + (w*h);
	write(1, &off, 4);
	
	const char rest6[] = { 0x8d, 0x82, 0x03, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x8e, 0x82,
		0x01, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x01, 0x12, 0xc6, 0x01, 0x00, 0x04, 0x00,
		0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x13, 0xc6, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x14, 0xc6, 0x02, 0x00, 0x07, 0x00, 0x00, 0x00
	};
	/* w*h + 50 * /32  a2  d6  00 */
	write(1, rest6, sizeof(rest6));
	off = 306 + (w*h);
	write(1, &off, 4);


	const char rest7[] = { 0x1d, 0xc6,
		0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x21, 0xc6, 0x0a, 0x00, 0x09, 0x00,
		0x00, 0x00
	};
		/* w*h + 58 * /3a  a2  d6  00 */ 
	write(1, rest7, sizeof(rest7));
	off = 314 + (w*h);
	write(1, &off, 4);
		
		
	const char rest8[] = { 0x28, 0xc6, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00 };	
	/* w*h + 130 * /82  a2 d6a210  0xd6  00 */
	write(1, rest8, sizeof(rest8));
	off = 386 + (w*h);
	write(1, &off, 4);

	const char rest9[] = { 0x00, 0x00, 0x00, 0x00, 0x49, 0x6d, 0x42, 0x61, 0x63, 0x6b, 0x00, 0x00, 0x75, 0x6e,
		0x6b, 0x6e, 0x6f, 0x77, 0x6e, 0x00, 0x69, 0x6d, 0x62, 0x72, 0x61, 0x77, 0x32, 0x64, 0x6e, 0x67,
		0x00, 0x00, 0x49, 0x6d, 0x42, 0x61, 0x63, 0x6b, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
		0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
	};
	write(1, rest9, sizeof(rest9));
	return 0;
}